name: Build and Push Docker Images

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      force_build_all:
        description: "Force build all services (ignore change detection)"
        required: false
        type: boolean
        default: false

env:
  DOCKER_REGISTRY: docker.io
  VERSION: "0.1.0"
  SERVICES: service-discovery,proxy-client,user-service,product-service,order-service,payment-service,shipping-service,favourite-service,api-gateway

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.detect.outputs.changed_services }}
      changed_services_json: ${{ steps.detect.outputs.changed_services_json }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      version_tag: ${{ steps.version.outputs.version_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate version tag
        id: version
        run: |
          BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          VERSION_TAG="v${{ env.VERSION }}-${BUILD_TIMESTAMP}"
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Version tag: ${VERSION_TAG}"

      - name: Detect changed services
        id: detect
        run: |
          if [[ "${{ github.event.inputs.force_build_all }}" == "true" ]]; then
            echo "Force build all services enabled"
            CHANGED_SERVICES="${{ env.SERVICES }}"
          else
            # Get changed files
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            else
              CHANGED_FILES="pom.xml"
            fi

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Detect which services changed
            CHANGED_SERVICES=""
            IFS=',' read -ra SERVICES_ARRAY <<< "${{ env.SERVICES }}"

            for service in "${SERVICES_ARRAY[@]}"; do
              if echo "$CHANGED_FILES" | grep -q "${service}/" || \
                 echo "$CHANGED_FILES" | grep -q "pom.xml" || \
                 echo "$CHANGED_FILES" | grep -q "infrastructure/kubernetes/"; then
                if [ -z "$CHANGED_SERVICES" ]; then
                  CHANGED_SERVICES="$service"
                else
                  CHANGED_SERVICES="$CHANGED_SERVICES,$service"
                fi
              fi
            done

            # If no specific service changed but other files did, build all
            if [ -z "$CHANGED_SERVICES" ] && [ -n "$CHANGED_FILES" ]; then
              CHANGED_SERVICES="${{ env.SERVICES }}"
            fi
          fi

          if [ -z "$CHANGED_SERVICES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No services to build"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_services=${CHANGED_SERVICES}" >> $GITHUB_OUTPUT

            # Convert comma-separated list to JSON array (trim whitespace)
            CHANGED_SERVICES_JSON=$(echo "$CHANGED_SERVICES" | jq -R -s -c 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length > 0))')
            echo "changed_services_json=${CHANGED_SERVICES_JSON}" >> $GITHUB_OUTPUT

            echo "Services to build: ${CHANGED_SERVICES}"
            echo "Services JSON: ${CHANGED_SERVICES_JSON}"
          fi

  build-all-services:
    name: Build All Services with Maven
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          cache: "maven"

      - name: Build all services with Maven
        run: |
          echo "========================================="
          echo "  Maven Multi-Module Build"
          echo "  Version: ${{ needs.detect-changes.outputs.version_tag }}"
          echo "========================================="

          # Build and install all services in parallel (2 threads per CPU core)
          mvn clean install -DskipTests -T 2C

          echo "âœ“ All services compiled and installed successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            **/target/*.jar
          retention-days: 1

  test-services:
    name: Test Service
    runs-on: ubuntu-latest
    needs: [detect-changes, build-all-services]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed_services_json) }}
      fail-fast: false
      max-parallel: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          cache: "maven"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts

      - name: Run tests for ${{ matrix.service }}
        run: |
          echo "Testing ${{ matrix.service }}..."
          mvn test -pl ${{ matrix.service }}
          echo "âœ“ ${{ matrix.service }} tests passed"

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/target/surefire-reports/*.xml
          check_name: Test Results - ${{ matrix.service }}

  sonarqube-analysis:
    name: SonarQube Code Analysis
    runs-on: ubuntu-latest
    needs: [detect-changes, build-all-services]
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for better analysis

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          cache: "maven"

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts

      - name: Run SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: |
          echo "Running SonarQube analysis for changed services..."

          IFS=',' read -ra SERVICES_ARRAY <<< "${{ needs.detect-changes.outputs.changed_services }}"

          for service in "${SERVICES_ARRAY[@]}"; do
            echo "Analyzing ${service}..."
            mvn sonar:sonar \
              -pl ${service} \
              -Dsonar.organization=${SONAR_ORGANIZATION} \
              -Dsonar.projectKey=Lrojas898_ecommerce-microservice-backend-app_${service} \
              -Dsonar.projectName="E-Commerce ${service}" \
              -Dsonar.host.url=${SONAR_HOST_URL} \
              -Dsonar.token=${SONAR_TOKEN} \
              -Dsonar.java.binaries=target/classes \
              -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml || echo "âš ï¸ SonarQube analysis failed for ${service} (non-blocking)"
          done

          echo "âœ“ SonarQube analysis completed"

  docker-build-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [detect-changes, test-services]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed_services_json) }}
      fail-fast: false
      max-parallel: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine service port
        id: port
        run: |
          # Trim whitespace from service name
          SERVICE=$(echo "${{ matrix.service }}" | xargs)
          case "${SERVICE}" in
            api-gateway) PORT=8080 ;;
            service-discovery) PORT=8761 ;;
            proxy-client) PORT=8080 ;;
            user-service) PORT=8081 ;;
            product-service) PORT=8082 ;;
            favourite-service) PORT=8086 ;;
            order-service) PORT=8083 ;;
            payment-service) PORT=8084 ;;
            shipping-service) PORT=8085 ;;
            *) PORT=8080 ;;
          esac
          echo "port=${PORT}" >> $GITHUB_OUTPUT

      - name: Create optimized Dockerfile
        id: dockerfile
        run: |
          # Trim whitespace from service name
          SERVICE=$(echo "${{ matrix.service }}" | xargs)
          VERSION="${{ env.VERSION }}"
          PORT="${{ steps.port.outputs.port }}"

          echo "service_name=${SERVICE}" >> $GITHUB_OUTPUT

          mkdir -p "${SERVICE}"

          echo "FROM eclipse-temurin:11-jre" > "${SERVICE}/Dockerfile.optimized"
          echo "WORKDIR /app" >> "${SERVICE}/Dockerfile.optimized"
          echo "COPY ${SERVICE}-v${VERSION}.jar app.jar" >> "${SERVICE}/Dockerfile.optimized"
          echo "EXPOSE ${PORT}" >> "${SERVICE}/Dockerfile.optimized"
          echo "HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 CMD curl -f http://localhost:${PORT}/actuator/health || exit 1" >> "${SERVICE}/Dockerfile.optimized"
          echo 'ENTRYPOINT ["java", "-jar", "app.jar"]' >> "${SERVICE}/Dockerfile.optimized"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.dockerfile.outputs.service_name }}/target
          file: ${{ steps.dockerfile.outputs.service_name }}/Dockerfile.optimized
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ steps.dockerfile.outputs.service_name }}:${{ env.VERSION }}
            ${{ secrets.DOCKER_USERNAME }}/${{ steps.dockerfile.outputs.service_name }}:${{ needs.detect-changes.outputs.version_tag }}
            ${{ secrets.DOCKER_USERNAME }}/${{ steps.dockerfile.outputs.service_name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        run: echo "Built and pushed ${{ secrets.DOCKER_USERNAME }}/${{ steps.dockerfile.outputs.service_name }}:${{ needs.detect-changes.outputs.version_tag }}"

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    needs: [detect-changes, docker-build-push]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed_services_json) }}
      fail-fast: false
      max-parallel: 3
    permissions:
      contents: read
      security-events: write # Required for uploading SARIF results
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trim service name
        id: service
        run: |
          SERVICE=$(echo "${{ matrix.service }}" | xargs)
          echo "name=${SERVICE}" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKER_USERNAME }}/${{ steps.service.outputs.name }}:${{ needs.detect-changes.outputs.version_tag }}
          format: "sarif"
          output: "trivy-results-${{ steps.service.outputs.name }}.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0" # No falla el build, solo reporta

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results-${{ steps.service.outputs.name }}.sarif"
          category: "trivy-${{ steps.service.outputs.name }}"

      - name: Generate human-readable report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKER_USERNAME }}/${{ steps.service.outputs.name }}:${{ needs.detect-changes.outputs.version_tag }}
          format: "table"
          output: "trivy-report-${{ steps.service.outputs.name }}.txt"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy report as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report-${{ steps.service.outputs.name }}
          path: trivy-report-${{ steps.service.outputs.name }}.txt
          retention-days: 30

      - name: Display scan summary
        if: always()
        run: |
          echo "========================================="
          echo "  Security Scan: ${{ steps.service.outputs.name }}"
          echo "========================================="
          if [ -f "trivy-report-${{ steps.service.outputs.name }}.txt" ]; then
            cat "trivy-report-${{ steps.service.outputs.name }}.txt"
          fi
          echo ""
          echo "ðŸ“Š Full report uploaded as artifact"
          echo "ðŸ”’ SARIF results uploaded to GitHub Security tab"

  generate-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    needs: [detect-changes, docker-build-push, trivy-scan]
    if: always() && needs.detect-changes.outputs.has_changes == 'true' && github.ref == 'refs/heads/master'
    permissions:
      contents: write
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Get latest tag
        id: get_latest_tag
        run: |
          # Get the latest tag, or default to v0.0.0 if no tags exist
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Analyze commits and determine version bump
        id: version_bump
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"

          # Remove 'v' prefix if exists
          CURRENT_VERSION="${LATEST_TAG#v}"

          # Split version into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Default to patch bump
          BUMP_TYPE="patch"

          # Get commits since last tag
          if [ "$LATEST_TAG" != "v0.0.0" ]; then
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s")
          else
            COMMITS=$(git log --pretty=format:"%s")
          fi

          echo "Analyzing commits:"
          echo "$COMMITS"

          # Check for breaking changes or major features
          if echo "$COMMITS" | grep -qiE "^(feat|feature|breaking|major)(\(.+\))?!:|BREAKING CHANGE:"; then
            BUMP_TYPE="major"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          # Check for new features
          elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
            BUMP_TYPE="minor"
            MINOR=$((MINOR + 1))
            PATCH=0
          # Default to patch for fixes and other changes
          else
            BUMP_TYPE="patch"
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          NEW_TAG="v${NEW_VERSION}"

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

          echo "Version bump: $BUMP_TYPE"
          echo "New version: $NEW_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          NEW_TAG="${{ steps.version_bump.outputs.new_tag }}"

          echo "Generating changelog from $LATEST_TAG to HEAD..."

          # Get commits since last tag
          if [ "$LATEST_TAG" != "v0.0.0" ]; then
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%h %s")
          else
            COMMITS=$(git log --pretty=format:"%h %s")
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -iE "^[a-f0-9]+ feat" || echo "")
          FIXES=$(echo "$COMMITS" | grep -iE "^[a-f0-9]+ fix" || echo "")
          CHORES=$(echo "$COMMITS" | grep -iE "^[a-f0-9]+ (chore|docs|style|refactor|perf|test)" || echo "")

          # Build changelog
          echo "# Release $NEW_TAG" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## Changes" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ Features" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$FEATURES" | while IFS= read -r line; do
              echo "- $line" >> RELEASE_NOTES.md
            done
            echo "" >> RELEASE_NOTES.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$FIXES" | while IFS= read -r line; do
              echo "- $line" >> RELEASE_NOTES.md
            done
            echo "" >> RELEASE_NOTES.md
          fi

          if [ -n "$CHORES" ]; then
            echo "### ðŸ”§ Maintenance" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$CHORES" | while IFS= read -r line; do
              echo "- $line" >> RELEASE_NOTES.md
            done
            echo "" >> RELEASE_NOTES.md
          fi

          # Add Docker images info
          echo "## Docker Images" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "Services built and pushed:" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          IFS=',' read -ra SERVICES_ARRAY <<< "${{ needs.detect-changes.outputs.changed_services }}"
          for service in "${SERVICES_ARRAY[@]}"; do
            echo "- \`${{ secrets.DOCKER_USERNAME }}/${service}:$NEW_TAG\`" >> RELEASE_NOTES.md
          done

          cat RELEASE_NOTES.md

          # Export for GitHub Release
          CHANGELOG_CONTENT=$(cat RELEASE_NOTES.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create and push tag
        id: tag
        run: |
          NEW_TAG="${{ steps.version_bump.outputs.new_tag }}"

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          echo "Creating tag $NEW_TAG..."

          TAG_MESSAGE="Release $NEW_TAG - Automated by GitHub Actions"
          git tag -a "$NEW_TAG" -m "$TAG_MESSAGE"

          git push origin "$NEW_TAG"

          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "âœ“ Tag $NEW_TAG created and pushed"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          name: Release ${{ steps.tag.outputs.new_tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs:
      [detect-changes, docker-build-push, trivy-scan, generate-release-notes]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Display build summary
        run: |
          echo "========================================="
          echo "  BUILD SUMMARY"
          echo "========================================="
          echo "âœ“ Services built: ${{ needs.detect-changes.outputs.changed_services }}"
          echo "âœ“ Version tag: ${{ needs.detect-changes.outputs.version_tag }}"

          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "âœ“ Release tag: ${{ needs.generate-release-notes.outputs.new_tag }}"
          fi

          echo ""
          echo "Docker Hub Images:"

          IFS=',' read -ra SERVICES_ARRAY <<< "${{ needs.detect-changes.outputs.changed_services }}"
          for service in "${SERVICES_ARRAY[@]}"; do
            echo "  â€¢ ${{ secrets.DOCKER_USERNAME }}/${service}:${{ needs.detect-changes.outputs.version_tag }}"
            echo "    ${{ secrets.DOCKER_USERNAME }}/${service}:${{ env.VERSION }}"
            echo "    ${{ secrets.DOCKER_USERNAME }}/${service}:latest"
          done

          echo ""
          echo "ðŸ”’ Security scans completed with Trivy"
          echo "   Check Security tab for vulnerability details"

          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo ""
            echo "ðŸ“ Release Notes generated"
            echo "   Tag: ${{ needs.generate-release-notes.outputs.new_tag }}"
            echo "   Check Releases page for full changelog"
          fi

          echo ""
          echo "Next steps:"
          echo "1. Review security scan results in Security tab"

          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "2. Review release notes in Releases page"
            echo "3. Update K8s manifests with new image tags"
            echo "4. Deploy to dev: Use deploy-dev workflow"
            echo "5. Deploy to prod: Use deploy-prod workflow (requires approval)"
          else
            echo "2. Update K8s manifests with new image tags"
            echo "3. Deploy to dev: Use deploy-dev workflow"
          fi

          echo "========================================="

      - name: Check job status
        if: contains(needs.*.result, 'failure')
        run: |
          echo "âŒ BUILD FAILED - Some jobs failed"
          exit 1
