name: Build and Push Docker Images

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      force_build_all:
        description: 'Force build all services (ignore change detection)'
        required: false
        type: boolean
        default: false

env:
  DOCKER_REGISTRY: docker.io
  VERSION: "0.1.0"
  SERVICES: service-discovery,proxy-client,user-service,product-service,order-service,payment-service,shipping-service,favourite-service,api-gateway

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.detect.outputs.changed_services }}
      changed_services_json: ${{ steps.detect.outputs.changed_services_json }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      version_tag: ${{ steps.version.outputs.version_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate version tag
        id: version
        run: |
          BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          VERSION_TAG="v${{ env.VERSION }}-${BUILD_TIMESTAMP}"
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Version tag: ${VERSION_TAG}"

      - name: Detect changed services
        id: detect
        run: |
          if [[ "${{ github.event.inputs.force_build_all }}" == "true" ]]; then
            echo "Force build all services enabled"
            CHANGED_SERVICES="${{ env.SERVICES }}"
          else
            # Get changed files
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            else
              CHANGED_FILES="pom.xml"
            fi

            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Detect which services changed
            CHANGED_SERVICES=""
            IFS=',' read -ra SERVICES_ARRAY <<< "${{ env.SERVICES }}"

            for service in "${SERVICES_ARRAY[@]}"; do
              if echo "$CHANGED_FILES" | grep -q "${service}/" || \
                 echo "$CHANGED_FILES" | grep -q "pom.xml" || \
                 echo "$CHANGED_FILES" | grep -q "infrastructure/kubernetes/"; then
                if [ -z "$CHANGED_SERVICES" ]; then
                  CHANGED_SERVICES="$service"
                else
                  CHANGED_SERVICES="$CHANGED_SERVICES,$service"
                fi
              fi
            done

            # If no specific service changed but other files did, build all
            if [ -z "$CHANGED_SERVICES" ] && [ -n "$CHANGED_FILES" ]; then
              CHANGED_SERVICES="${{ env.SERVICES }}"
            fi
          fi

          if [ -z "$CHANGED_SERVICES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No services to build"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_services=${CHANGED_SERVICES}" >> $GITHUB_OUTPUT

            # Convert comma-separated list to JSON array
            CHANGED_SERVICES_JSON=$(echo "$CHANGED_SERVICES" | jq -R -s -c 'split(",") | map(select(length > 0))')
            echo "changed_services_json=${CHANGED_SERVICES_JSON}" >> $GITHUB_OUTPUT

            echo "Services to build: ${CHANGED_SERVICES}"
            echo "Services JSON: ${CHANGED_SERVICES_JSON}"
          fi

  build-all-services:
    name: Build All Services with Maven
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build all services with Maven
        run: |
          echo "========================================="
          echo "  Maven Multi-Module Build"
          echo "  Version: ${{ needs.detect-changes.outputs.version_tag }}"
          echo "========================================="

          # Build and install all services in parallel (2 threads per CPU core)
          mvn clean install -DskipTests -T 2C

          echo "✓ All services compiled and installed successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            **/target/*.jar
          retention-days: 1

  test-services:
    name: Test Service
    runs-on: ubuntu-latest
    needs: [detect-changes, build-all-services]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed_services_json) }}
      fail-fast: false
      max-parallel: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts

      - name: Run tests for ${{ matrix.service }}
        run: |
          echo "Testing ${{ matrix.service }}..."
          mvn test -pl ${{ matrix.service }}
          echo "✓ ${{ matrix.service }} tests passed"

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/target/surefire-reports/*.xml
          check_name: Test Results - ${{ matrix.service }}

  sonarqube-analysis:
    name: SonarQube Code Analysis
    runs-on: ubuntu-latest
    needs: [detect-changes, build-all-services]
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts

      - name: Run SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          echo "Running SonarQube analysis for changed services..."

          IFS=',' read -ra SERVICES_ARRAY <<< "${{ needs.detect-changes.outputs.changed_services }}"

          for service in "${SERVICES_ARRAY[@]}"; do
            echo "Analyzing ${service}..."
            mvn sonar:sonar \
              -pl ${service} \
              -Dsonar.projectKey=ecommerce-${service} \
              -Dsonar.projectName="E-Commerce ${service}" \
              -Dsonar.host.url=${SONAR_HOST_URL} \
              -Dsonar.token=${SONAR_TOKEN} \
              -Dsonar.java.binaries=target/classes \
              -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml || echo "⚠️ SonarQube analysis failed for ${service} (non-blocking)"
          done

          echo "✓ SonarQube analysis completed"

  docker-build-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [detect-changes, test-services]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed_services_json) }}
      fail-fast: false
      max-parallel: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine service port
        id: port
        run: |
          case "${{ matrix.service }}" in
            api-gateway) PORT=8080 ;;
            service-discovery) PORT=8761 ;;
            proxy-client) PORT=8080 ;;
            user-service) PORT=8081 ;;
            product-service) PORT=8082 ;;
            favourite-service) PORT=8086 ;;
            order-service) PORT=8083 ;;
            payment-service) PORT=8084 ;;
            shipping-service) PORT=8085 ;;
            *) PORT=8080 ;;
          esac
          echo "port=${PORT}" >> $GITHUB_OUTPUT

      - name: Create optimized Dockerfile
        run: |
          mkdir -p ${{ matrix.service }}
          cat > ${{ matrix.service }}/Dockerfile.optimized <<EOF
          FROM eclipse-temurin:11-jre
          WORKDIR /app
          COPY ${{ matrix.service }}-v${{ env.VERSION }}.jar app.jar
          EXPOSE ${{ steps.port.outputs.port }}
          HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
            CMD curl -f http://localhost:${{ steps.port.outputs.port }}/actuator/health || exit 1
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service }}/target
          file: ${{ matrix.service }}/Dockerfile.optimized
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}:${{ env.VERSION }}
            ${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}:${{ needs.detect-changes.outputs.version_tag }}
            ${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        run: echo "Built and pushed ${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}:${{ needs.detect-changes.outputs.version_tag }}"

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, docker-build-push]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Display build summary
        run: |
          echo "========================================="
          echo "  BUILD SUMMARY"
          echo "========================================="
          echo "✓ Services built: ${{ needs.detect-changes.outputs.changed_services }}"
          echo "✓ Version tag: ${{ needs.detect-changes.outputs.version_tag }}"
          echo ""
          echo "Docker Hub Images:"

          IFS=',' read -ra SERVICES_ARRAY <<< "${{ needs.detect-changes.outputs.changed_services }}"
          for service in "${SERVICES_ARRAY[@]}"; do
            echo "  • ${{ secrets.DOCKER_USERNAME }}/${service}:${{ needs.detect-changes.outputs.version_tag }}"
            echo "    ${{ secrets.DOCKER_USERNAME }}/${service}:${{ env.VERSION }}"
            echo "    ${{ secrets.DOCKER_USERNAME }}/${service}:latest"
          done

          echo ""
          echo "Next steps:"
          echo "1. Update K8s manifests with new image tags"
          echo "2. Deploy to dev: Use deploy-dev workflow"
          echo "3. Deploy to prod: Use deploy-prod workflow (requires approval)"
          echo "========================================="

      - name: Check job status
        if: contains(needs.*.result, 'failure')
        run: |
          echo "❌ BUILD FAILED - Some jobs failed"
          exit 1
