name: Terraform Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to execute'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - prod
          - dev
        default: 'prod'
      auto_approve:
        description: 'Auto-approve apply/destroy (USE WITH CAUTION)'
        required: false
        type: boolean
        default: false

  push:
    branches:
      - master
      - main
    paths:
      - 'infrastructure/terraform/**'
      - '.github/workflows/terraform.yml'

  pull_request:
    branches:
      - master
      - main
    paths:
      - 'infrastructure/terraform/**'
      - '.github/workflows/terraform.yml'

env:
  TERRAFORM_VERSION: '1.5.0'
  TF_IN_AUTOMATION: 'true'
  TF_INPUT: 'false'

jobs:
  terraform-validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request' || github.event_name == 'push' || github.event.inputs.action == 'plan'
    defaults:
      run:
        working-directory: infrastructure/terraform
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<TFVARS
          do_token = "${{ secrets.DO_TOKEN }}"
          project_name = "ecommerce-microservices"
          environment = "${{ github.event.inputs.environment || 'prod' }}"
          cluster_region = "nyc1"
          cluster_version = "1.31.9-do.5"
          node_pool_size = "s-4vcpu-8gb"
          node_pool_count = 3
          node_pool_auto_scale = true
          node_pool_min_nodes = 3
          node_pool_max_nodes = 3
          enable_ingress_nginx = true
          enable_cert_manager = true
          letsencrypt_email = "${{ secrets.LETSENCRYPT_EMAIL }}"
          enable_monitoring = true
          tags = ["ecommerce", "kubernetes", "terraform", "${{ github.event.inputs.environment || 'prod' }}"]
          TFVARS

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -detailed-exitcode -out=tfplan || export EXITCODE=$?
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          exit ${EXITCODE:-0}
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}
        continue-on-error: true

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        if: steps.plan.outputs.exitcode == '2'
        with:
          name: terraform-plan
          path: infrastructure/terraform/tfplan
          retention-days: 5

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const exitcode = '${{ steps.plan.outputs.exitcode }}';
            let message = '### Terraform Plan Results\n\n';

            if (exitcode === '0') {
              message += 'âœ… No changes detected. Infrastructure is up to date.';
            } else if (exitcode === '2') {
              message += 'ðŸ“‹ Changes detected. Review the plan in the workflow logs.\n\n';
              message += '**Action Required:** Run `terraform apply` to apply these changes.';
            } else {
              message += 'âŒ Terraform plan failed. Check the workflow logs for details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Plan Summary
        run: |
          echo "### Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "âœ… **No changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The infrastructure matches the current Terraform configuration." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "ðŸ“‹ **Changes detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the plan output above to see what will be changed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To apply: Run the workflow with action='apply'" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Plan failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event.inputs.action == 'apply'
    environment:
      name: ${{ github.event.inputs.environment }}
    defaults:
      run:
        working-directory: infrastructure/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<TFVARS
          do_token = "${{ secrets.DO_TOKEN }}"
          project_name = "ecommerce-microservices"
          environment = "${{ github.event.inputs.environment }}"
          cluster_region = "nyc1"
          cluster_version = "1.31.9-do.5"
          node_pool_size = "s-4vcpu-8gb"
          node_pool_count = 3
          node_pool_auto_scale = true
          node_pool_min_nodes = 3
          node_pool_max_nodes = 3
          enable_ingress_nginx = true
          enable_cert_manager = true
          letsencrypt_email = "${{ secrets.LETSENCRYPT_EMAIL }}"
          enable_monitoring = true
          tags = ["ecommerce", "kubernetes", "terraform", "${{ github.event.inputs.environment }}"]
          TFVARS

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}

      - name: Wait for manual approval
        if: github.event.inputs.auto_approve != 'true'
        run: |
          echo "========================================="
          echo "  MANUAL APPROVAL REQUIRED"
          echo "========================================="
          echo ""
          echo "âš ï¸  This workflow requires manual approval through GitHub Environments."
          echo ""
          echo "Review the plan above and approve in the GitHub Actions UI."
          echo "========================================="

      - name: Terraform Apply
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" == "true" ]; then
            terraform apply -auto-approve tfplan
          else
            terraform apply tfplan
          fi
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}

      - name: Get Cluster Info
        id: cluster_info
        run: |
          CLUSTER_ID=$(terraform output -raw cluster_id 2>/dev/null || echo "")
          CLUSTER_ENDPOINT=$(terraform output -raw cluster_endpoint 2>/dev/null || echo "")
          echo "cluster_id=$CLUSTER_ID" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$CLUSTER_ENDPOINT" >> $GITHUB_OUTPUT

      - name: Save Terraform State
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-${{ github.event.inputs.environment }}
          path: infrastructure/terraform/terraform.tfstate
          retention-days: 30

      - name: Apply Summary
        run: |
          echo "### âœ… Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Cluster ID: \`${{ steps.cluster_info.outputs.cluster_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Endpoint: \`${{ steps.cluster_info.outputs.cluster_endpoint }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download kubeconfig: \`doctl kubernetes cluster kubeconfig save <cluster-id>\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Save KUBECONFIG as GitHub secret for deployment pipelines" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy services using deploy-dev or deploy-prod workflows" >> $GITHUB_STEP_SUMMARY

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event.inputs.action == 'destroy'
    environment:
      name: ${{ github.event.inputs.environment }}-destroy
    defaults:
      run:
        working-directory: infrastructure/terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: terraform-state-${{ github.event.inputs.environment }}
          path: infrastructure/terraform/

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<TFVARS
          do_token = "${{ secrets.DO_TOKEN }}"
          project_name = "ecommerce-microservices"
          environment = "${{ github.event.inputs.environment }}"
          cluster_region = "nyc1"
          cluster_version = "1.31.9-do.5"
          node_pool_size = "s-4vcpu-8gb"
          node_pool_count = 3
          node_pool_auto_scale = true
          node_pool_min_nodes = 3
          node_pool_max_nodes = 3
          enable_ingress_nginx = true
          enable_cert_manager = true
          letsencrypt_email = "${{ secrets.LETSENCRYPT_EMAIL }}"
          enable_monitoring = true
          tags = ["ecommerce", "kubernetes", "terraform", "${{ github.event.inputs.environment }}"]
          TFVARS

      - name: Terraform Destroy Plan
        run: terraform plan -destroy -out=destroy-plan
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}

      - name: Wait for manual approval
        if: github.event.inputs.auto_approve != 'true'
        run: |
          echo "========================================="
          echo "  âš ï¸  DESTRUCTIVE ACTION - APPROVAL REQUIRED"
          echo "========================================="
          echo ""
          echo "This will DESTROY all infrastructure resources!"
          echo ""
          echo "Review the destroy plan above carefully."
          echo "Approve in GitHub Actions UI to proceed."
          echo "========================================="

      - name: Terraform Destroy
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" == "true" ]; then
            terraform destroy -auto-approve
          else
            terraform apply destroy-plan
          fi
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}

      - name: Destroy Summary
        run: |
          echo "### ðŸ—‘ï¸ Terraform Destroy Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All infrastructure resources have been destroyed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Remember to remove the KUBECONFIG secret from GitHub if it's no longer needed." >> $GITHUB_STEP_SUMMARY
