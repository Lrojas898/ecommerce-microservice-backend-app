apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: logging
  labels:
    app: filebeat
data:
  filebeat.yml: |
    # Filebeat configuration for Kubernetes

    filebeat.inputs:
      # Collect container logs
      - type: container
        enabled: true
        paths:
          - /var/log/containers/*.log

        # Exclude logs from logging and kube-system namespaces
        exclude_files:
          - '.*kube-system.*'
          - '.*logging.*'

        # Parse JSON logs
        json.keys_under_root: true
        json.add_error_key: true
        json.message_key: message

        # Add Kubernetes metadata
        processors:
          - add_kubernetes_metadata:
              host: ${NODE_NAME}
              matchers:
                - logs_path:
                    logs_path: "/var/log/containers/"

          # Extract useful fields
          - decode_json_fields:
              fields: ["message"]
              target: ""
              overwrite_keys: true
              when:
                regexp:
                  message: "^{.*}$"

          # Add labels
          - add_labels:
              labels:
                cluster: ecommerce-k8s

          # Drop unneeded fields
          - drop_fields:
              fields:
                - "agent.ephemeral_id"
                - "agent.id"
                - "ecs.version"
              ignore_missing: true

    # Output to Elasticsearch
    output.elasticsearch:
      hosts: ['elasticsearch:9200']
      # Index pattern
      index: "ecommerce-logs-%{+yyyy.MM.dd}"

    # Setup Kibana dashboards (optional)
    setup.kibana:
      host: "kibana:5601"

    # Index lifecycle management
    setup.ilm.enabled: false
    setup.template.name: "ecommerce-logs"
    setup.template.pattern: "ecommerce-logs-*"

    # Logging configuration
    logging.level: info
    logging.to_files: false
    logging.to_stderr: true
